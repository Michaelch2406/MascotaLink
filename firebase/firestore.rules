rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isPaseador() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'PASEADOR';
    }

    function isDueno() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'DUEÑO';
    }

    function isPaseadorVerificado() {
      return get(/databases/$(database)/documents/paseadores/$(request.auth.uid)).data.verificacion_estado == 'aprobado';
    }

    // Collection group for zonas_servicio
    match /{path=**}/zonas_servicio/{zonaId} {
      allow read: if isAuthenticated();
    }

    // usuarios collection
    match /usuarios/{userId} {
      allow read: if isAuthenticated();

      allow create: if isOwner(userId) &&
        request.resource.data.email is string &&
        request.resource.data.rol in ['DUEÑO', 'PASEADOR'];

      allow update: if isOwner(userId) &&
        request.resource.data.rol == resource.data.rol &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['perfil_ref', 'verificacion_estado', 'verificacion_fecha'])) &&
        (resource.data.rol == 'PASEADOR'
          ? request.resource.data.verificacion_estado == resource.data.verificacion_estado
          : true);

      allow delete: if isOwner(userId);

      match /favoritos/{favoritoId} {
        allow read, write, delete: if isOwner(userId);
      }

      match /metodos_pago/{metodoId} {
        allow read, write: if isOwner(userId);
      }
    }

    // duenos collection
    match /duenos/{duenoId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(duenoId) && isDueno();
      allow update: if isOwner(duenoId);

      match /mascotas/{mascotaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(duenoId);
      }
    }

    // paseadores collection
    match /paseadores/{paseadorId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(paseadorId) && isPaseador();
      allow update: if isOwner(paseadorId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['verificacion_estado', 'verificacion_fecha', 'verificacion_notas']));

      match /disponibilidad/{diaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /tarifas/{tarifaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /zonas_servicio/{zonaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /resenas/{resenaId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isDueno() && request.resource.data.dueno_id == request.auth.uid;
      }
    }

    // Denormalized search collection
    match /paseadores_search/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(docId);
    }

    // reservas collection
    match /reservas/{reservaId} {
      allow read: if isAuthenticated() && (
        resource.data.id_dueno == /databases/$(database)/documents/usuarios/$(request.auth.uid) ||
        resource.data.id_paseador == /databases/$(database)/documents/usuarios/$(request.auth.uid) ||
        resource == null
      );

      allow create: if isAuthenticated() && isDueno() &&
        request.resource.data.id_dueno == /databases/$(database)/documents/usuarios/$(request.auth.uid);

      allow update: if isAuthenticated() && (
        (resource.data.id_dueno == /databases/$(database)/documents/usuarios/$(request.auth.uid) &&
          request.resource.data.estado in ['SOLICITADO', 'CANCELADO', 'COMPLETADO', 'CONFIRMADO']) ||
        (resource.data.id_paseador == /databases/$(database)/documents/usuarios/$(request.auth.uid) &&
          request.resource.data.estado in ['ACEPTADO', 'CONFIRMADO', 'EN_PROGRESO', 'EN_CURSO', 'COMPLETADO']) ||
        (
          (resource.data.id_dueno == /databases/$(database)/documents/usuarios/$(request.auth.uid) ||
            resource.data.id_paseador == /databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
          true
        )
      );
    }

    // pagos collection
    match /pagos/{pagoId} {
      allow read: if isAuthenticated() && (resource.data.id_usuario == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.id_usuario == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.id_usuario == request.auth.uid;
    }

    // chats collection
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && (
        resource.data.participantes[request.auth.uid] == true || resource == null
      );

      match /mensajes/{mensajeId} {
        allow read, write: if isAuthenticated();
      }
    }

    // audit_logs collection
    match /audit_logs/{logId} {
      allow read: if false;
      allow write: if isAuthenticated();
    }

    match /mascotas/{mascotaId} {
      allow read: if isAuthenticated();
    }
  }
}
