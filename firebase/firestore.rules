rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isPaseador() {
      let userDoc = get(/databases/$(database)/documents/usuarios/$(request.auth.uid));
      return userDoc != null && userDoc.data.get('rol', '') == 'PASEADOR';
    }

    function isDueno() {
      let userDoc = get(/databases/$(database)/documents/usuarios/$(request.auth.uid));
      let rol = userDoc != null ? userDoc.data.get('rol', '') : '';
      return rol == 'DUENO' || rol == 'DUEÑO';
    }

    // Acepta referencia a /usuarios/{uid} o string con el uid
    function isCurrentUser(value) {
      let userRef = /databases/$(database)/documents/usuarios/$(request.auth.uid);
      return (value is path && value == userRef) ||
        (value is string && value == request.auth.uid);
    }

    function isPaseadorVerificado() {
      let paseadorDoc = get(/databases/$(database)/documents/paseadores/$(request.auth.uid));
      return paseadorDoc != null && paseadorDoc.data.get('verificacion_estado', '') == 'aprobado';
    }

    // Collection group for zonas_servicio
    match /{path=**}/zonas_servicio/{zonaId} {
      allow read: if isAuthenticated();
    }

    // usuarios collection
    match /usuarios/{userId} {
      allow read: if isAuthenticated();

      allow create: if isOwner(userId) &&
        request.resource.data.correo is string &&
        request.resource.data.rol in ['DUENO', 'DUEÑO', 'PASEADOR'];

      allow update: if isOwner(userId) &&
        request.resource.data.rol == resource.data.rol &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['perfil_ref', 'verificacion_estado', 'verificacion_fecha'])) &&
        (resource.data.rol == 'PASEADOR'
          ? request.resource.data.get('verificacion_estado', '') == resource.data.get('verificacion_estado', '')
          : true);

      allow delete: if isOwner(userId);

      match /favoritos/{favoritoId} {
        allow read, write, delete: if isOwner(userId);
      }

      match /metodos_pago/{metodoId} {
        allow read, write: if isOwner(userId);
      }
    }

    // duenos collection
    match /duenos/{duenoId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(duenoId) && getAfter(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol in ['DUENO', 'DUEÑO'];
      allow update: if isOwner(duenoId) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['calificacion_promedio', 'total_resenas']));

      match /mascotas/{mascotaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(duenoId);
      }
    }

    // paseadores collection
    match /paseadores/{paseadorId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(paseadorId) && getAfter(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'PASEADOR';
      allow update: if (isOwner(paseadorId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['verificacion_estado', 'verificacion_fecha', 'verificacion_notas'])))
        || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['calificacion_promedio', 'total_resenas']));

      match /disponibilidad/{diaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /tarifas/{tarifaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /zonas_servicio/{zonaId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(paseadorId);
      }
      match /resenas/{resenaId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isDueno() && request.resource.data.dueno_id == request.auth.uid;
      }
    }

    // Reviews Root Collections
    match /resenas_paseadores/{resenaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.autorId == request.auth.uid;
      allow update, delete: if false;
    }

    match /resenas_duenos/{resenaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.autorId == request.auth.uid;
      allow update, delete: if false;
    }

    // Denormalized search collection
    match /paseadores_search/{docId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(docId);
    }

    // reservas collection
    match /reservas/{reservaId} {
      // Lectura individual: verificar que el usuario es el dueño o paseador
      allow get: if isAuthenticated() && (
        isCurrentUser(resource.data.get('id_dueno', null)) ||
        isCurrentUser(resource.data.get('id_paseador', null))
      );

      // Consultas/queries: permitir si está autenticado
      // La app debe filtrar por id_dueno o id_paseador en las queries
      allow list: if isAuthenticated();

      allow create: if isAuthenticated() && isDueno() &&
        isCurrentUser(request.resource.data.get('id_dueno', null));

      allow update: if isAuthenticated() && resource != null && (
        (isCurrentUser(resource.data.get('id_dueno', null)) &&
          request.resource.data.get('estado', '') in ['SOLICITADO', 'CANCELADO', 'COMPLETADO', 'CONFIRMADO']) ||
        (isCurrentUser(resource.data.get('id_paseador', null)) &&
          request.resource.data.get('estado', '') in ['ACEPTADO', 'CONFIRMADO', 'EN_PROGRESO', 'EN_CURSO', 'COMPLETADO']) ||
        (
          (isCurrentUser(resource.data.get('id_dueno', null)) ||
            isCurrentUser(resource.data.get('id_paseador', null))) &&
          true
        )
      );
    }

    // pagos collection
    match /pagos/{pagoId} {
      allow read: if isAuthenticated() && (resource.data.id_usuario == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.id_usuario == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.id_usuario == request.auth.uid;
    }

    // chats collection
    match /chats/{chatId} {
      function isParticipantInResource() {
        return isAuthenticated()
          && resource.data.participantes is list
          && resource.data.participantes.hasAny([request.auth.uid]);
      }

      function isParticipantInCreate() {
        return isAuthenticated()
          && request.resource.data.participantes is list
          && request.resource.data.participantes.hasAny([request.auth.uid]);
      }

      // Permitir list (queries) si está autenticado - la query whereArrayContains ya filtra
      allow list: if isAuthenticated();
      // Permitir get (lectura individual) solo si es participante
      allow get: if isParticipantInResource();
      allow create: if isParticipantInCreate();
      allow update: if isParticipantInResource()
        && request.resource.data.keys().hasOnly([
          'participantes', 'fecha_creacion', 'ultimo_mensaje', 'ultimo_timestamp',
          'mensajes_no_leidos', 'estado_usuarios', 'chat_abierto', 'ultima_actividad'
        ]);
      allow delete: if false;

      match /mensajes/{mensajeId} {
        // Permitir lectura si el chatId contiene el uid del usuario
        allow read: if isAuthenticated() && chatId.matches('.*' + request.auth.uid + '.*');

        // Permitir creación si el chatId contiene el uid del usuario y es el remitente
        allow create: if isAuthenticated()
          && chatId.matches('.*' + request.auth.uid + '.*')
          && request.resource.data.id_remitente == request.auth.uid;

        // Permitir actualización de leido/entregado si es participante del chat
        allow update: if isAuthenticated()
          && chatId.matches('.*' + request.auth.uid + '.*')
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['leido', 'entregado']);

        allow delete: if false;
      }
    }

    // notificaciones collection
    match /notificaciones/{notificacionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // audit_logs collection
    match /audit_logs/{logId} {
      allow read: if false;
      allow write: if isAuthenticated();
    }

    match /mascotas/{mascotaId} {
      allow read: if isAuthenticated();
    }
  }
}
