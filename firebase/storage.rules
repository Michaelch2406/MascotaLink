rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Regla específica para las fotos de perfil de las mascotas.
    match /foto_perfil_mascota/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && fileName.matches(request.auth.uid + "_.*")
    }

    // Regla para fotos de paseos (PaseoEnCursoActivity)
    // Permite leer y escribir fotos en la carpeta del paseo a usuarios autenticados
    match /paseos/{reservaId}/{fileName} {
      allow read: if request.auth != null;
      // Permitir escribir si el usuario está autenticado.
      // Idealmente deberíamos verificar si el usuario participa en la reserva,
      // pero Storage rules no tiene acceso directo a Firestore para validar IDs.
      // Para este prototipo, la autenticación es suficiente barrera.
      allow write: if request.auth != null;
    }

    // Regla general para carpetas de usuario (dueños, paseadores).
    match /{folder}/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (userId == request.auth.uid || userId.matches(request.auth.uid + "_.*"));
    }
  }
}